<?php
include "config.php"; 
session_start();

$error = ""; 


if (isset($_POST['register'])) {
    $fullname = $_POST['fullname'];
    $username = $_POST['username'];
    $email    = $_POST['email'];
    $birthday = $_POST['birthday'];
    $password = password_hash($_POST['password'], PASSWORD_DEFAULT); 

    if (isset($_FILES['profile_pic']) && $_FILES['profile_pic']['name'] != "") {
        $target_dir = "uploads/";
        if (!is_dir($target_dir)) mkdir($target_dir, 0777, true);

        $file_name = time() . "_" . basename($_FILES["profile_pic"]["name"]);
        $target_file = $target_dir . $file_name;

        if (move_uploaded_file($_FILES["profile_pic"]["tmp_name"], $target_file)) {
            $profile_pic = $file_name;
        } else {
            $profile_pic = 'profile-pic.jpg';
        }
    } else {
        $profile_pic = 'profile-pic.jpg';
    }

    
    $check = $conn->query("SELECT * FROM users WHERE username='$username' OR email='$email'");
    if ($check->num_rows > 0) {
        $error = "Username or email already exists!";
    } else {
       
        $sql = "INSERT INTO users (fullname, username, email, birthday, password, profile_pic)
                VALUES ('$fullname', '$username', '$email', '$birthday', '$password', '$profile_pic')";
        if ($conn->query($sql)) {
            
            $_SESSION['user_id'] = $conn->insert_id;
            $_SESSION['username'] = $username;
            $_SESSION['profile_pic'] = $profile_pic;

           
            header("Location: dashboard.php");
            exit();
        } else {
            $error = "Error: " . $conn->error;
        }
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlumiNest >< Register</title>
<link rel="stylesheet" href="style.css?v=<?=time();?>">
</head>
<body>


<div class="center-page">
    <div class="aesthetic-container">
        <h2>AlumiNest >< Create Account</h2>

        <?php if ($error): ?>
            <div class="error-box"><?= $error ?></div>
        <?php endif; ?>

        
        <form method="POST" enctype="multipart/form-data">
            <input type="text" name="fullname" placeholder="Full Name" required>
            <input type="text" name="username" placeholder="Username" required>
            <input type="email" name="email" placeholder="Email" required>
            <label>Birthday</label>
            <input type="date" name="birthday" required>
            <input type="password" name="password" placeholder="Password" required>
            <label>Profile Picture</label>
            <input type="file" name="profile_pic" accept="image/*">

            <button name="register">Register</button>
        </form>

        <p>Already have an account? <a href="index.php">Login</a></p>
    </div>
</div>

</body>
</html>
